<!DOCTYPE html>
<link rel="stylesheet" href="style.css"> 
<script src="dualchart_channels.js" style="text/javascript" ></script>

<script style="text/javascript" >
	function makeTicks(maxes, num_to_print, n) {
		if (Math.min(maxes) < 0) return [0];
		H = [];
		bases = [];
		for(var i=0; i<maxes.length; i++){
			h = maxes[i]/n;
			base = Math.floor(Math.log10(h)-Math.log10(5));
			bases.push(base);
			H.push(Math.round(h/Math.pow(10, base))*Math.pow(10, base));
		}

		ticks = [];
		ticksstr = [];
		alive = true;
		for(var i=0; alive; i++) {
			alive = false;
			labelstr = '';
			for(var j=0; j<maxes.length; j++) {
				if (j<num_to_print) {
					if (ticks.length <= j+1)
						ticks.push([]);
					ticks[j].push(H[j]*i);
					labelstr += (H[j]*i).toFixed(bases[j] > 0 ? 0:-bases[j]);
					if (j != num_to_print-1)
						labelstr += ' / ';
				}
				if (H[j]*(i) < maxes[j])
					alive = true;
			}
			ticksstr.push(labelstr);
			
		}
		return [ticks, ticksstr];
	}

	function sign(x) {
		if(x>0) return 1;
		if(x<0) return -1;
		return 0;
	}

	chart_name = 'chart';

	function drawTicks(axis, ticklabels, ff, f0, gf, g0, marg) {
		altaxis = axis == 'x' ? 'y':'x';
		realaxis = axis == 'z' ? 'y':axis;
		xgrid = document.getElementById(chart_name+'_'+axis+'_grid');
		while(xgrid.firstChild) xgrid.removeChild(xgrid.firstChild);

		labels = document.getElementById(chart_name+'_'+axis+'_axis_labels');
		while(labels.firstChild) labels.removeChild(labels.firstChild);

		gfl = (axis=='z'?gf:g0) + (axis=='y'?-1:1)*marg;

		for (i in ticklabels) {
			line = document.createElementNS('http://www.w3.org/2000/svg','line');
			line.setAttribute(altaxis+'1', gf); line.setAttribute(altaxis+'2', g0);
			fp = f0 + (ff-f0)*(i/ticklabels.length);
			line.setAttribute(realaxis+'1', fp);
			line.setAttribute(realaxis+'2', fp);
			line.setAttribute('class', 'grid');
			xgrid.append(line);

			label = document.createElementNS('http://www.w3.org/2000/svg','text');
			label.setAttribute(altaxis, gfl);
			label.setAttribute(realaxis, fp);
			label.innerHTML = i==0 ? '0' : ticklabels[i];
			labels.append(label);
		}
	}

	function linterp(xs, ys, xq) {
		i;
		for (i=1; i<xs.length-1 && !isNaN(xs[i]) && xq>xs[i]; i++) {}
		return ys[i-1] + (ys[i]-ys[i-1])/(xs[i]-xs[i-1])*(xq-xs[i-1]);
	}

	function gids(id, val) {
		document.getElementById(id).value = (typeof val == 'string' ? val : val.toFixed(3));
	}

	function drawchart() {
		[t, v, d, cur, f] = channels;

		svg = document.getElementById('chart');
		x_axis = document.getElementById('chart_x_axis');
		y_axis = document.getElementById('chart_y_axis');

		x0 = Math.min(y_axis.x1.baseVal.value, y_axis.x2.baseVal.value);
		xf = Math.max(y_axis.x1.baseVal.value, y_axis.x2.baseVal.value);
		y0 = Math.max(x_axis.y1.baseVal.value, x_axis.y2.baseVal.value);
		yf = Math.min(x_axis.y1.baseVal.value, x_axis.y2.baseVal.value);

		d_line = document.getElementById('chart_d_line');
		v_line = document.getElementById('chart_v_line');
		cur_line = document.getElementById('chart_cur_line');
		f_line = document.getElementById('chart_f_line');
		d_line.setAttribute("points",""); // I don't like it, but it does clear the points
		v_line.setAttribute("points",""); // I don't like it, but it does clear the points
		cur_line.setAttribute("points",""); // I don't like it, but it does clear the points
		f_line.setAttribute('points','');

		[[t_ticks], xticklabels] = makeTicks([Math.max(...t)], 1, 9);
		[[d_ticks, v_ticks], yticklabels] = makeTicks([Math.max(...d), Math.max(...v), Math.max(...cur), Math.max(...f)], 2, 6);
		[[cur_ticks, f_ticks], zticklabels] = makeTicks([Math.max(...cur), Math.max(...f), Math.max(...d), Math.max(...v)], 2, 6);
		
		t_max = t_ticks[t_ticks.length-1];
		d_max = d_ticks[d_ticks.length-1];
		v_max = v_ticks[v_ticks.length-1];
		cur_max = cur_ticks[cur_ticks.length-1];
		f_max = f_ticks[f_ticks.length-1];

		drawTicks('x', xticklabels, xf, x0, yf, y0, 15);
		drawTicks('y', yticklabels, yf, y0, xf, x0, 5);
		drawTicks('z', zticklabels, yf, y0, xf, x0, 5);

		for (i in t) {
			var ptd = svg.createSVGPoint();
			var ptv = svg.createSVGPoint();
			var ptcur = svg.createSVGPoint();
			var ptf = svg.createSVGPoint();

			xq = x0 + (xf-x0)/(t_max-0)*t[i];
			ptf.x = ptv.x = ptd.x = ptcur.x = xq;

			ptd.y   = y0 + (yf-y0)/(d_max-0)*d[i];
			ptv.y   = y0 + (yf-y0)/(v_max-0)*v[i];
			ptcur.y = y0 + (yf-y0)/(cur_max-0)*cur[i];
			ptf.y   = y0 + (yf-y0)/(f_max-0)*f[i];
			d_line.points.appendItem(ptd);
			v_line.points.appendItem(ptv);
			cur_line.points.appendItem(ptcur);
			f_line.points.appendItem(ptf);
		}
		
		bg=document.getElementById('chart');

		qline = document.getElementById('chart_query_line');
		qline.setAttribute('opacity', 0);

		gids('query_time', '-');
		gids('query_d', '-');
		gids('query_v', '-');
		gids('query_cur', '-');
		gids('query_f', '-');

		handler = function(event){
			if(event.buttons != 1) return;
				xq = event.clientX - bg.getBoundingClientRect().left;
				yq = event.clientY - bg.getBoundingClientRect().top;

				tq = (t_max-0)/(xf-x0)*(xq-x0);
				if (tq>Math.max(...t)){
					tq = Math.max(...t);
					xq = x0 + (xf-x0)/(t_max-0)*tq;
				}
				if (tq<0) {
					tq=0; xq=x0;
				}
				dq   = linterp(t, d, tq);
				vq   = linterp(t, v, tq);
				curq = linterp(t, cur, tq);
				fq   = linterp(t, f, tq);
				qline.setAttribute('opacity', 1);

				qline.setAttribute('x1', xq);
				qline.setAttribute('x2', xq);

				gids('query_time', tq);
				gids('query_d', dq);
				gids('query_v', vq);
				gids('query_cur', curq);
				gids('query_f', fq);
			}
		bg.addEventListener('mousemove', handler);
		bg.addEventListener('mousedown', handler);
	}

</script>


<style>
.rowlabel {
  position: relative;
  padding: 3px;
  /*display: inline-block;*/
  border-bottom: 1px dotted black;
}

.rowlabel .ttt::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}

.rowlabel:hover .ttt {
  visibility: visible;
  opacity: 1;
}

.graph .labels.x-labels {
  text-anchor: middle;
}

.graph .labels.y-labels {
  text-anchor: end;
}
.graph .labels.z-labels {
  text-anchor: start;
}


.graph {
  height: 550px;
  width: 800px;
  margin: 10px;
}

.graph .background {
  fill: #e5f0e0;
}
.output-graph {
  background-color: #b5e0a0;
}

.graph .axes {
  stroke: #333;
  stroke-dasharray: 0;
  stroke-width: 1.5;
}

.graph .grid {
  stroke: #ccc;
  stroke-dasharray: 0;
  stroke-width: 1;
}

.labels {
  font-size: 13px;
}

.label-title {
  font-weight: bold;
  font-size: 12px;
  text-anchor: middle;
}

.query-line line {
  stroke: #55a040;
  stroke-width: 2;
}

.qline-hidden {
  opacity: 0;
}
</style>

<body onload="drawchart()">

<svg version="1.2" class="graph" id='chart' aria-labelledby="title" role="img">
  <title id="title">Position/Velocity Data</title>


<rect class="background" id="chart_background" x=90 y=20 width=615 height=430 />
<g class="x-grid">
  <line id="chart_x_axis" class="axes" x1="90" x2="90" y1="20" y2="450"></line>
</g>
<g class="y-grid">
  <line id="chart_y_axis" class="axes" x1="90" x2="705" y1=450 y2=450></line>
  <line id="chart_z_axis" class="axes" x1="705" x2="705" y1="20" y2=450></line>
</g>

<g class="x-grid" id="chart_x_grid"></g>
<g class="y-grid" id="chart_y_grid"></g>
<g class="z-grid" id="chart_z_grid"></g>

<g class="labels x-labels" id='chart_x_labels'>
  <text x="375" y=485 class="label-title">Time [s]</text>
</g>

<g class="labels y-labels" id='chart_y_labels'>
  <text x=-300 y=15 class="label-title" transform="rotate(270)" id="chart_d_label" fill="#0074d9">Position [ft]</text>
  <text x=-180 y=15 class="label-title" transform="rotate(270)" id="chart_v_label" fill="#d91200">Velocity [ft/s]</text>
  <text x=-240 y=15 class="label-title" transform="rotate(270)" id="chart_y1_divider" fill="#111">/</text>
</g>

<g class="labels z-labels" id='chart_z_labels'>
  <text x=-300 y=800 class="label-title" transform="rotate(270)" id="chart_cur_label" fill="#444">Current [A]</text>
  <text x=-180 y=800 class="label-title" transform="rotate(270)" id="chart_f_label" fill="#c48900">Force [lbf]</text>
  <text x=-240 y=800 class="label-title" transform="rotate(270)" id="chart_y1_divider" fill="#111">/</text>
</g>

<g class="labels x-labels" id='chart_x_axis_labels'></g>
<g class="labels z-labels" id='chart_z_axis_labels'></g>
<g class="labels y-labels" id='chart_y_axis_labels'></g>

<g class="query-line">
	<line id="chart_query_line" x1=100 x2=100 y1=15 y2=455></line>
</g>
<polyline
	id='chart_d_line'
	fill='none'
	stroke='#0074d9'
	stroke-width=2
	points="
	"/>
<polyline
	id='chart_v_line'
	fill='none'
	stroke='#d91200'
	stroke-width=2
	points="
	"/>
<polyline
	id='chart_cur_line'
	fill='none'
	stroke='#444'
	stroke-width=2
	points="
	"/>
<polyline
	id='chart_f_line'
	fill='none'
	stroke='#c48900'
	stroke-width=2
	points="
	"/>
</svg>
	
	<div class="output-graph">
		Try dragging on the chart. A vertical bar should appear to probe values with.
		<table>
			<tr>
				<th class="rowlabel">Queried Time</th>
				<td><input id="query_time" readonly /></td>
				<td class="unit">[s]</td>
			</tr><tr>
				<th class="rowlabel">Position</th>
				<td><input id="query_d" readonly /></td>
				<td class="unit" id="unit_query_d">[ft]</td>
			</tr><tr>
				<th class="rowlabel">Velocity</th>
				<td><input id="query_v" readonly /></td>
				<td class="unit" id="unit_query_v">[ft/s]</td>
			</tr><tr>
				<th class="rowlabel">Current</th>
				<td><input id="query_cur" readonly /></td>
				<td class="unit">[A]</td>
			</tr><tr>
				<th class="rowlabel">Actuator Force</th>
				<td><input id="query_f" readonly /></td>
				<td class="unit" id="unit_query_f">[ft/s]</td>
			</tr>
		</div>

</body>